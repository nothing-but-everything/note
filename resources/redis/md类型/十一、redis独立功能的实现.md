# 十一、redis独立功能的实现


## 发布与订阅


### 频道的订阅与退订


#### redis服务器将所有频道的订阅关系保存到redis服务器状态redisServer结构中的pubsub_channels字典中。


#### 字典中的每一个键对应一个频道的名称，字典中的每一个值都是一个链表，保存了所有订阅该频道的客户端；


#### 通过SUBSCRIBE命令订阅频道；通过UNSUBSCRIBE命令退订频道；


### 模式的订阅与退订


#### redis服务器将所有模式的订阅关系保存到redis服务器状态redisServer结构中的pubsub_patterns链表中；


#### 链表中的每一个节点都是一个pubsubPattern结构，结构中保存了模式的名称，订阅该模式的客户端；


#### 通过PSUBSCRIBE命令订阅模式；通过PUNSUBSCRIBE命令退订模式；


### 消息的发布


#### 服务器接收到客户端发送的PUBLISH channel message命令时，需要做两件事：


#### 1.将message消息发送给所有订阅了channel频道的客户端；


#### 2.如果由一个或多个模式与channel频道相匹配，将message消息也发送给订阅了这些模式的客户端；


### PUBSUB命令


#### redis2.8新增了PUBSUB命令，用于查看频道或模式的相关信息，该命令有三种用法：


#### 1.PUBSUB channes


##### 用于返回服务器当前被订阅的频道；


##### 如果命令携带pattern参数，则用于返回被订阅的频道中匹配pattern模式的频道；


#### 2.PUBSUB NUMSUB


##### 接收任意多个频道作为输入参数，用于返回每个频道的订阅者数量；


#### 3.PUBSUN NUMPAT


##### 用于返回服务器中被订阅模式的数量，即redisServer.pubsub_patterns链表的长度；


## 事务


### AICD


#### A atomicity 原子性


##### 数据库中的状态转换操作时原子的，不可分割的；


#### C consistency 一致性


##### 数据库中的数据描述是符合现实世界的全部约束；


##### 数据符合数据库本身的定义和要求；


#### I Isolation 隔离性


##### 数据库中的各个状态转换操作应当是隔离的，互不影响的；


#### D durability 持久性


##### 数据库中状态转换结果应当是能够永久保留的；


### 事务执行流程：


#### 事务开始


##### 客户端向服务器发送MUTI命令，标志事务的开始；


##### 客户端将客户端状态redisClient结构中的flags标识设置为REDIS_MUTI，从非事务状态转换至事务状态；


#### 命令入队


##### 处于非事务状态的客户端发送的命令会被服务器立即执行；而服务器接收到处于事务状态的客户端发送的命令请求时有不同的处理策略：


##### 1.如果客户端发送DISCARD、MUTI、EXEC、WATCH命令中的一种，服务器立即执行；


##### 2.如果客户端发送非以上任意一种命令，服务器将命令保存到一个先进先出的队列中；


#### 事务开始


##### 服务器接收到客户端发送的EXEC命令，开始执行事务，遍历执行队列中的每一条命令，然后将得到的结果全部返回给客户端；


### WATCH命令：


#### WATCH命令是一个乐观锁，作用是服务器在执行EXEC命令之前，监视任意数量的数据库键。并在服务器处理EXEC命令时，如果至少有一个被监视的键发生修改时，则拒绝执行事务，并向客户端返回一个事务失败的空回复。


#### 服务器状态redisServer结构中的watched_keys字典记录了所有被监视的数据库键及监视该键的客户端。字典中的每一个键都是一个指向键空间中某个被监视的数据库键；字典中的每一个值都是一个链表，记录了监视该数据库键的所有客户端；


#### 所有对数据库键进行修改的命令在执行之后都会调用touchWatchKey函数检查被修改的键是否存在于watched_keys字典中。如果存在，就将字典中键对应链表中的每个客户端redisClient结构中的flags标识设置为REDIS_DIRTY标识。


#### 服务器接收到客户端发送的EXEC命令时，检查客户端redisClient结构中的flags标识，如果标识为REDIS_DIRTY，证明至少有一个键被修改，则拒绝执行，冰箱客户端返回一个事务执行失败的空回复；


### 事务在执行过程中即使遇到错误也不会终止执行，也不会对已执行命令及已执行命令产生的结果有任何影响。


## 慢查询日志


### redis服务器提供的慢查询日志功能用于保存那些执行时间超过给定时长的命令请求，通过慢查询日志监视和优化查询速度；


### 慢查询日志功能有关的服务器配置选项：


#### slowlog-slow-slower-than


##### 执行时间超过slowlog-slow-slower-than的命令请求会生成一条慢查询日志；


#### slowlog-max-len


##### 慢查询日志功能最多保存多少条日志；


### 服务器状态redisServer结构中和慢查询日志功能有关属性：


#### slowlog_entry_id


##### 下一条慢查询日志id；


#### slowlog


##### 链表，保存了所有慢查询日志；


#### slowlog-slow-slower-than


##### 服务器配置选项同名属性；


#### slowlog-max-len


##### 服务器配置选项同名属性；


### redis服务器执行命令请求之前和之后都会执行系统调用，获取微妙格式的时间戳，将他们的差值作为命令请求的执行时间。然后调用slowlogPushEntryIfNeeded函数决定是否有必要为刚才执行的命令请求创建慢查询日志。


## 监视器


### 客户端向服务器发送MONITOR命令，可以成为服务器的监视器用于实时接收并打印服务器执行的命令请求。


### MONITOR命令原理：


#### 服务器将对应客户端状态redisClient结构中的flags标识设置为REDIS_MONITOR；


#### 服务器将对应客户端状态redisClient结构添加到redisServer.monitors链表表尾；


### 服务器的命令执行器执行命令请求之前都会调用replicationFeedMonitor函数，将命令请求的相关信息发送给所有监视器。

